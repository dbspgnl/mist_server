<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>
<body>
	<div class="wrapper">
		<div class="button-container">
			<button class="load-button">로드</button>
			<button class="record-button">녹화</button>
			<button class="stop-button">중지</button>
			<button class="play-button">녹화보기</button>
			<a class="download-button">다운로드</a>
		</div>
		<div class="video-container">
			<div class="video-item">
				<h2>미리보기</h2>
				<video muted crossOrigin="anonymous" id="preview"></video>
			</div>
			<div class="video-item">
				<h2>미리보기</h2>
				<video id="recording"></video>
			</div>
		</div>
	</div> 
	<style>
		*  {margin: 0; padding: 0; }
		html, body { height: 100%; }
		.wrapper {height: 100%; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;}
		.video-container { display: flex; width: 550px; padding: 1rem; justify-content: space-around; }
		.video-item > h2 { text-align: center;}
		.video-item > video { border: 1px solid red; width: 250px; height: 188px; }
		button, a { border: none; font-size: 14px; background: #ccc; padding: 0.5rem 1rem; cursor: pointer; text-decoration: none; color: black;}
	</style>	
	<script src="flv.js"></script>
	<script>
		const loadButton = document.querySelector(".load-button");
		const recordButton = document.querySelector(".record-button");
		const stopButton = document.querySelector(".stop-button");
		const playButton = document.querySelector(".play-button");
		const downloadButton = document.querySelector(".download-button");
		const previewPlayer = document.querySelector("#preview");
		const recoringPlayer = document.querySelector("#recording");

		let recorder;
		let recordedChunks;
		let flvPlayer;

		const videoLoad = () => {
			let layout = document.getElementById(`preview`);

			// flv
			// flvPlayer = flvjs.createPlayer({
			// 	type: 'flv',
			// 	hasVideo: true,
			// 	url: `http://localhost:8080/mist0.flv` // strea server 2개로 테스트
			// });
			// flvPlayer.attachMediaElement(layout);
			// flvPlayer.load();
			// flvPlayer.play();

			// cam
			// navigator.mediaDevices.getUserMedia({video: true, audio: true})
			// 	.then(stream => previewPlayer.srcObject = stream; startRecording(previewPlayer.captureStream());)

			// mp4 
			previewPlayer.src = "https://cdn.coverr.co/videos/coverr--07-022-22-girl-with-analog-camera_0011-6845/1080p.mp4";
			previewPlayer.play();
		}

		const videoStart = () => {
			console.log("녹화 시작...");
			startRecording();
			// setTimeout(() => {
			// 	stopRecording();
			// }, 13000);
		}

		const startRecording = () => {
			recordedChunks = [];
			let layout = document.getElementById(`preview`);
			var stream = layout.captureStream();
			var partSize = 0;
			const MIN_BLOB_SIZE = 5000000;
			recorder = new MediaRecorder(stream);
			recorder.start(1000); // interval 주기로 처리
			recorder.ondataavailable = (e) => {
				// console.log(e.data);
				// recordedChunks.push(e.data);

				const blob = e.data;
				partSize += blob.size;
				recordedChunks.push(blob);
				if (partSize >= MIN_BLOB_SIZE) {
					let bigBlob = new Blob(parts, { type: blob.type });
					// if the blob size doesn't need to be precise:
					partSize = 0;
					recordedChunks = [];
				}
				
			}
		}

		const stopRecording = () => {
			flvPlayer.pause();
			recorder.stop();
			console.log(recordedChunks);
		}

		const playRecording = () => {
			const recordedBlob = new Blob(recordedChunks, {type: "video/mp4"});
			recoringPlayer.src = URL.createObjectURL(recordedBlob);
			recoringPlayer.play();
			downloadButton.href = recoringPlayer.src;
			downloadButton.download = `recording_${new Date()}.mp4`;
		}

		// 레코드 감지 후 처리
		// mediaRecorder.onstop = (e) => {
		// 	console.log("data available after MediaRecorder.stop() called.");
		// 	const audio = document.createElement("audio");
		// 	audio.controls = true;
		// 	const blob = new Blob(chunks, { type: "audio/ogg; codecs=opus" });
		// 	const audioURL = window.URL.createObjectURL(blob);
		// 	audio.src = audioURL;
		// 	console.log("recorder stopped");
		// };

		loadButton.addEventListener("click", videoLoad);
		recordButton.addEventListener("click", videoStart);
		stopButton.addEventListener("click", stopRecording);
		playButton.addEventListener("click", playRecording);
		
	</script>
</body>
</html>